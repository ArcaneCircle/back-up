function getFPS(){frame++;var t=(new Date).getTime();return timeInterval=1e3/(t-lastTime),lastTime=t,frame%10==0&&(avgFps=Math.round(10*timeInterval)/10),avgFps.toFixed(0)}function init(){state=Constants.STATE_INIT,canvas=document.getElementById("game"),canvasRect=canvas.getBoundingClientRect(),(ctx=canvas.getContext("2d")).webkitImageSmoothingEnabled=!1,ratio=canvas.width/canvas.height,resizeCanvas(),preload=new Preloader(this,200,32),mousePosition={x:0,y:0},canvas.addEventListener("mousemove",onMouseMove,!1),canvas.addEventListener("mousedown",onMouseDown,!1),canvas.addEventListener("mouseup",onMouseUp,!1),canvas.addEventListener("touchmove",onTouchMove,!1),canvas.addEventListener("touchstart",onTouchDown,!1),canvas.addEventListener("touchend",onTouchUp,!1),canvas.addEventListener("keydown",onKeyDown,!1),canvas.addEventListener("keyup",onKeyUp,!1),setInterval(update,1e3/Constants.FPS)}function resizeCanvas(){canvas.height=window.innerHeight,canvas.width=canvas.height*ratio,scale=canvas.width/Constants.WIDTH}function printText(t,s,i,e,h){var a=-1,n=i.length,o=images["a/font.png"],r=h||1,c=0;for(e&&(c=24*n*r*.5);a++<n;)ctx.drawImage(o,(i.charCodeAt(a)-32)%10*32,32*(Math.floor((i.charCodeAt(a)-32)/10)-1),32,32,(t-c)*scale+24*a*scale*r,s*scale,32*r*scale,32*r*scale)}function onKeyDown(t){if(state==Constants.STATE_GAME){t.keyCode;game.onMouseDown(1)}}function onKeyUp(t){if(state==Constants.STATE_GAME){t.keyCode;game.onMouseUp(1)}}function onMouseMove(t){mousePosition=getMousePosition(canvas,t)}function onMouseDown(t){state==Constants.STATE_GAME&&game.onMouseDown(1)}function onMouseUp(t){state==Constants.STATE_MENU?menu.click(mousePosition.x,mousePosition.y):state==Constants.STATE_GAME&&game.onMouseUp(1)}function onTouchMove(t){t.preventDefault(),mousePosition=getTouchPosition(canvas,t)}function onTouchDown(t){t.preventDefault(),mousePosition=getTouchPosition(canvas,t),state==Constants.STATE_GAME&&(mousePosition.x<.5*Constants.WIDTH*scale?game.onMouseDown(1):game.onMouseDown(2))}function onTouchUp(t){t.preventDefault(),mousePosition=getTouchPosition(canvas,t),state==Constants.STATE_MENU?(isTouch=!0,menu.click(mousePosition.x,mousePosition.y)):state==Constants.STATE_GAME&&(mousePosition.x<.5*Constants.WIDTH*scale?game.onMouseUp(1):game.onMouseUp(2))}function getTouchPosition(t,s){return{x:s.changedTouches[0].pageX-t.offsetLeft,y:s.changedTouches[0].pageY-t.offsetTop}}function getMousePosition(t,s){return{x:s.pageX-t.offsetLeft,y:s.pageY-t.offsetTop}}function loadAllImages(t){totalImages=t.length;for(var s in t)loadImage(t[s])}function loadImage(t){images[t]=new Image,images[t].onload=function(){loadedImages+=1,preload.update(loadedImages,totalImages)},images[t].src=t}function startGame(t){numPlayers=t,transFunc=onTransitionGame,trans.start()}function quitGame(){transFunc=onTransitionQuit,trans.start()}function onTransitionQuit(){game.cleanUp(),game=null,(menu=new Menu).init(),state=Constants.STATE_MENU}function onTransitionGame(){(game=new Game).init(),state=Constants.STATE_GAME,menu.cleanUp(),menu=null}function update(){switch(ctx.clearRect(0,0,canvas.width,canvas.height),state){case Constants.STATE_INIT:preload.isReady&&(loadAllImages(sources),state=Constants.STATE_LOAD);break;case Constants.STATE_LOAD:preload.draw(),preload.isComplete&&((menu=new Menu).init(),trans=new Transition,state=Constants.STATE_MENU);break;case Constants.STATE_MENU:menu.update(mousePosition.x,mousePosition.y),menu.draw();break;case Constants.STATE_GAME:game.update(mousePosition.x,mousePosition.y),game.draw()}trans&&(trans.update(),trans.draw()),Constants.STATE_LOAD}var Particle=function(t){this.img=t,this.x=0,this.y=0,this.scale=1,this.ox=-.5*this.img.width,this.oy=-.5*this.img.height,this.v=!1,this.life=1,this.maxLife=1,this.fade=0,this.dx=0,this.dy=0,this.scaling=1};Particle.prototype={init:function(){},setScale:function(t){this.scale=t,this.ox=this.img.width*this.scale*-.5,this.oy=this.img.height*this.scale*-.5},draw:function(){this.v&&ctx.drawImage(this.img,(this.x+this.ox)*scale,(this.y+this.oy)*scale,this.img.width*this.scale*scale,this.img.height*this.scale*scale)}};var ParticleSystem=function(){this.x=this.y=0,this.v=!0,this.isRun=this.isPause=!1,this.p=[],this.count=0,this.ls=this.lr=0,this.dx=this.dy=0,this.dxR=this.dyR=0,this.scaling=1,this.fX=this.fY=0,this.spI=1,this.spN=0,this.spW=this.spH=0,this.fo=0,this.dur=0,this.wc=this.ic=!1};ParticleSystem.prototype={init:function(t,s,i,e,h){this.count=s,this.ls=i,this.dx=e,this.dy=h;for(var a=this.count;a-- >0;){var n=new Particle(t);this.p.push(n)}},start:function(t){this.dur=t||0,this.isRun=!0,this.dur>0?this.wc=!0:this.wc=!1,this.ic=!1;for(var s=this.fo;s-- >0;)this.update()},stop:function(){this.isRun=!1},pause:function(){this.isPause=!0},resume:function(){this.isPause=!1},burst:function(t){if(!this.paused)for(var s=t;s-- >0;)this.addParticle(this.randomSpeed(this.dx,this.dxR),this.randomSpeed(this.dy,this.dyR),this.randomLife(this.ls));this.wc=!0,this.ic=!1},addParticle:function(t,s,i){for(var e=this.count;e-- >0;){var h=this.p[e];if(!h.v)break}h.x=this.x,h.y=this.y,0!=this.spW&&(h.x+=Math.random()*this.spW-.5*this.spW),0!=this.spH&&(h.y+=Math.random()*this.spH-.5*this.spH),h.setScale(1),h.maxLife=i,h.life=i,h.fade=1/i,h.dx=t,h.dy=s,h.scaling=this.scaling,h.v=!0},randomSpeed:function(t,s){return t+=s=(t+1)*s*Math.random()-(t+1)*s*.5},randomLife:function(t){return t-=(t+1)*this.lr*Math.random()},setForces:function(t,s){this.fX=t||0,this.fY=s||0},setScaling:function(t){this.scaling=t},setlrness:function(t){this.lr=t},setSpeed:function(t,s){this.dx=t,this.dy=s},setSpeedRandomness:function(t,s){this.dxR=t,this.dyR=s},setSpawnArea:function(t,s){this.spW=t,this.spH=s},setSpawnInterval:function(t){this.spI=t},setFrameOffset:function(t){this.fo=t},update:function(){if(!this.isPause){this.dur>0&&0==--this.dur&&this.stop(),this.isRun&&!this.isPause&&(this.spN>=this.spI&&(this.addParticle(this.randomSpeed(this.dx,this.dxR),this.randomSpeed(this.dy,this.dyR),this.randomLife(this.ls)),this.spN=0),this.spN++);for(var t=this.count;t-- >0;){var s=this.p[t];s.v&&(--s.life<=0?s.v=!1:(s.dy+=this.fY,s.dx+=this.fX,s.x+=s.dx,s.y+=s.dy,s.setScale(s.scale*s.scaling)))}if(this.wc&&!this.ic){var i=!0;for(t=this.count;t-- >0;)if(this.p[t].v){i=!1;break}i&&(this.ic=!0)}}},draw:function(){for(var t=this.count;t-- >0;)this.p[t].draw()},cleanUp:function(){this.p=null},reset:function(){for(var t=this.count;t-- >0;)this.p[t].v=!1}};var Platform=function(t){this.x=0,this.y=0,this.by=0,this.scale=1,this.ox=0,this.oy=0,this.drop=0,this.img=images[t],this.v=!0,this.w=this.img.width,this.h=this.img.height,this.type="basic",this.isOff=!1,this.isUsed=!0};Platform.prototype={getX:function(){return this.x+this.ox},getY:function(){return this.y+this.oy},setScale:function(t){this.scale=t,this.w=this.img.width*this.scale,this.h=this.img.height*this.scale,this.ox=.72*this.w*-.5},destroy:function(){this.img=null},draw:function(){this.v&&this.isUsed&&ctx.drawImage(this.img,(this.x+this.ox)*scale,(this.y+this.oy+this.drop)*scale,this.img.width*this.scale*scale*.72,this.img.height*this.scale*scale*.72)}};var Player=function(){this.x=this.y=0,this.w=this.h=0,this.ox=this.oy=0,this.sx=this.sy=1,this.img=images["a/p.png"],this.isAlive=!0,this.v=!0,this.dx=this.dy=0,this.animDir=1,this.hop=0,this.isJump=!1,this.isFall=!1,this.isTunnel=!1,this.currPlatform=null,target=this};Player.prototype={init:function(){},getX:function(){return this.x+this.ox},getY:function(){return this.y+this.oy},setScale:function(t,s){this.sx=t,this.sy=s,this.w=this.img.width*this.sx,this.h=this.img.height*this.sy,this.ox=-.5*this.w,this.oy=-1*this.h},draw:function(){this.v&&ctx.drawImage(this.img,(this.x+this.ox)*scale,(this.y+this.oy+this.hop)*scale,this.img.width*this.sx*scale,this.img.height*this.sy*scale)},jump:function(t){this.isJump||(this.dy=-18*t,this.isJump=!0,this.setScale(.95,1.1),this.hop=0,this.currPlatform=null)},land:function(){this.isJump=!1,this.dy=0,this.setScale(1.05,.9),this.animDir=1,this.hop=0},walkAnim:function(){this.animDir>0?this.sy<1.1?(this.sy+=.01,this.sx-=.005,this.hop-=.5):(this.sx=.95,this.sy=1.1,this.animDir=-1):this.sy>.9?(this.sy-=.01,this.sx+=.005,this.hop+=.5):(this.sx=1.05,this.sy=.9,this.animDir=1,this.hop=0),this.setScale(this.sx,this.sy)},update:function(t,s){this.isJump||this.walkAnim()}};var Preloader=function(t,s,i){this.root=t,this.width=s||200,this.height=i||20,this.progress=0,this.totalResources=0,this.resourcesLoaded=0,this.isReady=!1,this.isComplete=!1,target=this,this.bar=new Image,this.bar.onload=function(){target.isReady=!0},this.bar.src="a/grey_pixel.png"};Preloader.prototype={draw:function(){this.drawImage(this.bar,Constants.WIDTH/2-this.width/2,Constants.HEIGHT/2-this.height/2,this.width*this.progress,this.height)},drawImage:function(t,s,i,e,h){ctx.drawImage(t,s*this.root.scale,i*this.root.scale,e*this.root.scale,h*this.root.scale)},update:function(t,s){this.resourcesLoaded=t,this.totalResources=s,this.progress=this.resourcesLoaded/this.totalResources,this.totalResources>0&&1==this.progress&&(this.isComplete=!0)}};var Transition=function(){this.v=!1,this.position=Constants.HEIGHT,this.speed=60,this.isTop=!0,target=this};Transition.prototype={start:function(){this.position=Constants.HEIGHT,this.v=!0,this.isTop=!0},onComplete:function(){this.v=!1},onHidden:function(){transFunc()},draw:function(){if(this.v){var t=0;this.position>0&&(t=this.position*scale),ctx.clearRect(0,t,canvas.width,(this.position+Constants.HEIGHT)*scale)}},update:function(){this.v&&(this.position-=this.speed,this.position<=0&&this.isTop?(this.onHidden(),this.isTop=!1):this.position<=-1*Constants.HEIGHT&&this.onComplete())}};var Tree=function(t,s){this.x=t,this.y=0,this.img=images["a/back_tree.png"],this.sx=s/this.img.width,this.sy=720,this.v=!0};Tree.prototype={draw:function(){this.v&&ctx.drawImage(this.img,this.x*scale,this.y*scale,this.img.width*this.sx*scale,this.img.height*this.sy*scale)}};var Vector2D=function(t,s){this.x=t||0,this.y=s||0};Vector2D.prototype={magnitude:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalise:function(){var t=this.magnitude();return this.x=this.x/t,this.y=this.y/t,this},dot:function(t){return this.x*t.x+this.y*t.y},a:function(t){return Math.atan2(this.y,this.x)*(t?1:Vector2DConst.TO_DEG)},vector:function(t){this.x=Math.sin(t*Vector2DConst.TO_RAD),this.y=-Math.cos(t*Vector2DConst.TO_RAD)}},Vector2DConst={TO_DEG:180/Math.PI,TO_RAD:Math.PI/180};var Wall=function(t){this.x=this.y=0,this.by=0,this.ox=this.oy=0,this.sx=this.sy=1,this.init(t),this.isFront=!0,this.v=!0};Wall.prototype={init:function(t){var s="w3";t?s="ws":Math.random()<.3&&(s="w2"),this.ft=images["a/"+s+".png"]},getX:function(){return this.x+this.ox},getY:function(){return this.y+this.oy},setScale:function(t){this.sx=t,this.ox=.48*this.ft.width*this.sx*-.5},draw:function(){this.v&&this.isFront&&(ctx.drawImage(this.ft,(this.x+this.ox)*scale,(this.y+this.oy)*scale,this.ft.width*this.sx*scale*.48,this.ft.height*this.sy*scale*.48),ctx.globalAlpha=1)}};var Beam=function(t,s,i,e){this.x=t,this.y=s,this.img=images["a/ray.png"],this.sx=i/this.img.width,this.sy=1,this.r=e,this.v=!0};Beam.prototype={draw:function(){this.v&&(ctx.translate(this.x*scale,this.y*scale),ctx.rotate(this.r),ctx.drawImage(this.img,this.x*scale,this.y*scale,this.img.width*this.sx*scale,this.img.height*this.sy*scale),ctx.rotate(-this.r),ctx.translate(-this.x*scale,-this.y*scale))}};var Button=function(t,s,i){this.x=t||0,this.y=s||0,this.img=i,this.w=this.h=0,this.v=!0,this.isOver=!1,this.text="",this.icon=null,target=this};Button.prototype={click:function(t,s){return t>this.getX()&&t<this.getX()+this.getWidth()&&s>this.getY()&&s<this.getY()+this.getHeight()},getX:function(){return this.x*scale},getY:function(){return this.y*scale},getWidth:function(){return this.w*scale},getHeight:function(){return this.h*scale},setText:function(t){this.text=t},update:function(t,s){this.isOver?(this.w=this.img.width,this.h=this.img.height,(t<this.getX()||t>this.getX()+this.getWidth()||s<this.getY()||s>this.getY()+this.getHeight())&&(this.isOver=!1)):(this.w=this.img.width,this.h=this.img.height,t>this.getX()&&t<this.getX()+this.getWidth()&&s>this.getY()&&s<this.getY()+this.getHeight()&&(this.isOver=!0))},draw:function(){if(this.v){var t=0;this.isOver&&(t=4),ctx.drawImage(this.img,this.x*scale,(this.y+t)*scale,this.img.width*scale,this.img.height*scale),printText(this.x+.5*this.img.width,this.y+t+.5*this.img.height-8,this.text,!0)}}},Collisions={circle:function(t,s,i,e,h,a){return new Vector2D(e-t,h-s).magnitude()<=i+a}},Constants={STATE_INIT:0,STATE_LOAD:1,STATE_MENU:2,STATE_GAME:3,WIDTH:480,HEIGHT:720,FPS:60,TO_DEG:180/Math.PI,TO_RAD:Math.PI/180};var sources=["a/pause_out.png","a/sky.png","a/title.png","a/font.png","a/bar.png","a/bar_base.png","a/p.png","a/leaf.png","a/platform.png","a/branch.png","a/w2.png","a/w3.png","a/ws.png","a/back_tree.png","a/ray.png"],images={},loadedImages=0,totalImages=0,preload,menu,game,trans,transFunc,canvas=null,canvasRect=null,ctx=null,state,scale,ratio,mousePosition,buttons=[],target=this;window.onload=init,window.addEventListener("resize",resizeCanvas,!1);var hiscore=0,firstPlay1=!0,isTouch=!1,timeInterval=0,lastTime=0,frame=0,avgFps=0,Game=function(){this.isRun=!0,this.isCharge=!1,this.pow=0,this.score=0,this.p=null,this.cx=240,this.cy=-144,this.co=0,this.rad=120,this.circ=Math.PI*this.rad*2,this.ang=0,this.lev=[],this.walls=[],this.plats=[],this.layouts=[[[1,1,1,1,0,1,1,1,1,0,1,1,1,1,0,0],[1,1,0,1,1,1,0,0,1,1,1,0,0,1,1,1],[1,0,1,1,1,0,1,1,1,1,1,1,0,0,1,1],[1,1,1,1,0,0,1,1,1,1,0,0,1,1,1,1],[1,1,0,1,1,0,1,1,0,1,1,1,1,1,1,1]],[[1,1,1,1,0,1,1,1,1,0,1,1,1,1,0,0],[1,1,0,1,1,1,0,0,1,1,1,0,0,1,1,1],[1,0,1,1,1,0,1,1,1,1,1,1,0,0,1,1],[1,1,1,1,0,0,1,1,1,1,0,0,1,1,1,1],[1,1,0,1,1,0,1,1,0,1,1,1,1,1,1,1]]],this.nextLayout=0,this.currLev=0,this.speed=.01;var t=Math.PI/8;this.trees=[new Tree(50,32),new Tree(150,48),new Tree(280,64),new Tree(400,32),new Tree(550,64)],this.beams=[new Beam(100,-100,40,t),new Beam(150,-100,60,t),new Beam(170,-120,100,t),new Beam(250,-100,60,t),new Beam(350,-80,100,t),new Beam(390,-120,60,t),new Beam(500,-80,100,t)],this.hud=new HUD,this.lf=new ParticleSystem,this.music=new Music,target=this};Game.prototype={init:function(){this.score=0,this.hud.setScore(this.score),this.lf.init(images["a/leaf.png"],15,100,0,-2),this.lf.setSpawnArea(50,0),this.lf.setForces(0,.2),this.lf.setSpeedRandomness(2,2),this.lf.setScaling(.98),this.buildLevel()},pausePressed:function(){this.isRun?this.pause():this.resume()},pause:function(){this.isRun=!1},resume:function(){this.isRun=!0},onKeyDown:function(t){1==t&&this.onMouseDown()},onKeyUp:function(t){1==t&&this.onMouseUp()},onMouseDown:function(t){if(this.isRun){if(this.hud.buttonPause.isOver)return;this.p.isAlive&&(this.isCharge=!0),this.hud.showHelp1=!1}},onMouseUp:function(t){if(this.isRun){if(this.hud.buttonPause.isOver)return void this.hud.click(mousePosition.x,mousePosition.y);this.p.isAlive&&(this.isCharge=!1,this.p.jump(this.pow),this.pow=0)}},buildLevel:function(){var t,s=[];for(t=0;t<18;t+=3)s[t]=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],s[t+1]=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],s[t+2]=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;t<s.length;t++)this.addLevel(t,s)},addLevel:function(t,s){for(var i=0;i<16;i++){var e=2*Math.PI/16*i,h=!1;t>1&&(1!=s[t][i]&&3!=s[t][i]||(h=!0));var a=new Wall(h);if(this.walls.push(a),a.a=e,a.d=this.cy+Math.cos(e)*this.rad,a.x=this.cx+Math.sin(e)*this.rad,a.y=this.cy-48*t,a.by=48*(t+2),1==s[t][i]||3==s[t][i]){var n=new Platform("a/platform.png");this.lev.push(n),this.plats.push(n),n.a=e,3==s[t][i]?n.type="tunnel":n.type="basic",n.setScale(1+.5*Math.random()),n.d=this.cy+Math.cos(e)*(this.rad+64),n.x=this.cx+Math.sin(e)*(this.rad+64),n.y=this.cy-48*(t+1),n.by=48*(t+1),n.wall=a}}this.p=new Player,this.p.setScale(1,1),this.p.x=240,this.p.y=530,this.p.isAlive=!0},updateLevel:function(){for(var t=0;t<this.lev.length;t++){var s=64;"branch"==this.lev[t].type&&(s=24),this.lev[t].a+=this.speed,this.lev[t].d=Math.cos(this.lev[t].a)*(this.rad+s)+this.lev[t].y,this.lev[t].x=this.cx+Math.sin(this.lev[t].a)*(this.rad+s),Math.cos(this.lev[t].a)*(this.rad+s)>0?this.lev[t].isOff=!0:this.lev[t].isOff=!1}for(var i=0;i<this.walls.length;i++)this.walls[i].a+=this.speed,this.walls[i].d=Math.cos(this.walls[i].a)*this.rad+this.walls[i].y,this.walls[i].x=this.cx+Math.sin(this.walls[i].a)*this.rad,this.walls[i].setScale(Math.cos(this.walls[i].a)*this.rad/this.rad),Math.cos(this.walls[i].a)*this.rad<0?this.walls[i].isFront=!0:this.walls[i].isFront=!1},drawLevel:function(){var t,s=[];for(t=0;t<this.lev.length;t++)s.push(this.lev[t]);for(t=0;t<this.walls.length;t++)s.push(this.walls[t]);for(s.sort(function(t,s){return t.d-s.d}),t=s.length-1;--t>0;)s[t].draw()},drawImage:function(t,s,i,e,h){var a=e||t.width,n=h||t.height;ctx.drawImage(t,s*scale,i*scale,.5+~~(a*scale),.5+~~(n*scale))},checkFall:function(t){var s=this.p.x,i=this.p.y+this.p.h;return!(this.colPointPlatform(s,i+1,t)&&t.isUsed&&!t.isOff)||(this.p.currPlatform=t,!1)},colPointPlatform:function(t,s,i){if(!i.v)return!1;var e=i.x-i.w/2,h=i.x+i.w/2;return t>e&&t<h&&s>i.y&&s<i.y+i.h},draw:function(){},update:function(t,s){this.drawImage(images["a/sky.png"],0,0,480);var i;for(i=0;i<this.trees.length;i++)this.trees[i].x+=100*this.speed,this.trees[i].x>750&&(this.trees[i].x-=750+this.trees[i].w),this.trees[i].draw();for(this.hud.update(t,s),this.isCharge&&(this.pow+=.02,this.pow>1&&(this.pow=0),this.hud.barScale=this.pow),this.p.isJump&&(this.p.dy<0&&this.p.y<=Constants.HEIGHT/2?(this.cy-=this.p.dy,this.co-=this.p.dy):this.p.y+=this.p.dy,this.p.dy+=.5,this.p.dy>16&&(this.p.dy=16)),i=0;i<this.lev.length;i++)this.lev[i].y=this.lev[i].by+this.cy;for(i=0;i<this.walls.length;i++)this.walls[i].y=this.walls[i].by+this.cy;var e=this.p.x,h=this.p.y;if(!this.p.isTunnel)if(this.p.isJump){for(i=0;i<this.plats.length;i++)if(this.plats[i].v&&!this.p.isFall&&!this.plats[i].isOff&&this.plats[i].isUsed&&this.p.dy>0){var a=this.plats[i].x-this.plats[i].w/2,n=this.plats[i].x+this.plats[i].w/2;if(e>a&&e<n&&h>this.plats[i].y&&h<this.plats[i].y+this.plats[i].h&&h-this.p.dy<this.plats[i].y){var o=this.p.y-this.plats[i].y;this.p.dy<0&&this.p.y<=Constants.HEIGHT/2?(this.cy+=o,this.co+=o):this.p.y-=o,this.p.land();break}this.p.y>Constants.HEIGHT&&this.p.isAlive&&(this.p.isAlive=!1,this.music.stopSequence(),quitGame())}}else if(0==this.p.dy)for(i=0;i<this.plats.length;i++){if(!this.checkFall(this.plats[i])){this.p.isJump=!1;break}this.p.isJump=!0}for(i=0;i<this.walls.length;i++)this.walls[i].y>Constants.HEIGHT&&(this.walls[i].by-=864,this.walls[i].init(!1));for(i=0;i<this.lev.length;i++)if(this.lev[i].y>Constants.HEIGHT){for(var r=this.lev[i].by,c=this.layouts[this.currLev][this.nextLayout],u=0,l=0;l<this.lev.length;l++)this.lev[l].by==r&&(this.lev[l].by-=864,this.lev[l].y=this.cy+this.lev[l].by,this.lev[l].isUsed=!1,1==c[u]&&(this.lev[l].isUsed=!0,this.lev[l].setScale(1+.5*Math.random()),this.lev[l].wall.init(!0)),u++);++this.nextLayout>4&&(this.nextLayout=0)}for(i=0;i<this.plats.length;i++)this.plats[i]==this.p.currPlatform?this.plats[i].drop=0:this.plats[i].drop=-4;for(this.updateLevel(),this.drawLevel(),this.p.update(),this.p.draw(),this.lf.x=this.p.x,this.lf.y=this.p.y,this.lf.update(),this.lf.draw(),i=0;i<this.beams.length;i++)this.beams[i].x-=100*this.speed,this.beams[i].x<-200&&(this.beams[i].x+=750),this.beams[i].draw();for(;this.co>48;)this.score++,this.hud.setScore(this.score),this.co-=48;this.score>hiscore&&(hiscore=this.score),this.hud.draw()},cleanUp:function(){}};var HUD=function(){this.score=0,this.isPaused=!1,this.buttonPause=new Button(Constants.WIDTH-74,10,images["a/pause_out.png"]),this.bar=images["a/bar.png"],this.barBase=images["a/bar_base.png"],this.barScale=0,this.showHelp=!0,firstPlay1||(this.showHelp=!1),target=this};HUD.prototype={init:function(){},setScore:function(t){this.score=t},click:function(t,s){this.buttonPause.click(t,s)&&(game.isRunning=!1,quitGame())},draw:function(){this.showHelp,this.buttonPause.draw(),printText(240,48,""+this.score,!0,1.5),ctx.drawImage(this.bar,26*scale,577*scale+this.bar.height*(1-this.barScale)*scale,(this.bar.width+1)*scale,this.bar.height*this.barScale*scale),ctx.drawImage(this.barBase,20*scale,570*scale,this.barBase.width*scale,this.barBase.height*scale)},update:function(t,s){this.buttonPause.update(t,s)}};var Menu=function(){this.title=images["a/title.png"],this.isReady=!1,target=this};Menu.prototype={init:function(){},click:function(t,s){startGame()},draw:function(){this.drawImage(images["a/sky.png"],0,0,480),this.drawImage(this.title,130,180),printText(240,520,"TAP TO PLAY",!0)},drawImage:function(t,s,i,e,h){var a=e||t.width,n=h||t.height;ctx.drawImage(t,s*scale,i*scale,.5+~~(a*scale*1.5),.5+~~(n*scale*1.5))},update:function(t,s){},cleanUp:function(){}};var Music=function(){this.context=new(window.AudioContext||window.webkitAudioContext),this.buffers=[],this.loaded=0,this.src=null,this.currStep=-1;var t=99;this.seq=[-3,t,t,t,-1,t,t,t,0,t,t,t,-3,t,2,t,-3,t,t,t,-1,t,t,t,4,t,t,t,2,t,t,t,-3,t,t,t,-1,t,-1,t,0,t,0,t,-3,t,2,t,-3,t,t,t,-1,t,t,t,4,t,t,t,2,t,0,t,4,t,t,t,5,t,t,t,4,t,t,t,5,t,t,t,7,t,t,t,4,t,t,t,2,t,t,t,t,t,t,t,2,t,t,t,4,t,t,t,2,t,t,t,4,t,t,t,2,t,t,t,-1,t,t,t,-3,t,t,t,t,t,t,t],this.freq=[130.81,138.59,146.83,155.56,164.81,174.61,185,196,207.65,220,233.08,246.94,261.63,277.18,293.66,311.13,329.63,349.23,369.99,392,415.3,440,466.16,493.88,523.25],this.freqOffset=12,this.tempo=140,this.interval=100,this.loadSound("a/xylo.mp3",0)};Music.prototype={loadSound:function(t,s){var i=this,e=new XMLHttpRequest;e.open("GET",t,!0),e.responseType="arraybuffer",e.onload=function(){i.context.decodeAudioData(e.response,function(t){i.buffers[s]=t,1==++i.loaded&&i.onSoundsLoaded()},function(t){})},e.send()},onSoundsLoaded:function(){this.playSequence()},getFrequency:function(t){return this.freq[this.freqOffset+t]/this.freq[this.freqOffset]},playNote:function(t,s){if(99!=s){var i=this.context.createBufferSource();i.buffer=this.buffers[t],i.connect(this.context.destination),i.start(0),i.playbackRate.value=this.getFrequency(s)}var e=this;setTimeout(function(){e.onNoteComplete()},this.interval)},onNoteComplete:function(){this.currStep>=0&&(++this.currStep>this.seq.length-1&&(this.currStep=0),this.playNote(0,this.seq[this.currStep]))},playSequence:function(){this.currStep=0,this.playNote(0,this.seq[this.currStep])},stopSequence:function(){this.currStep=-1}};